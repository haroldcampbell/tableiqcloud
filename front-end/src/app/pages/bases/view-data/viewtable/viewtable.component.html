<div class="host-container">
  <div class="actions-container">
    <ul class="action-group">
      <li class="action-item">
        <img class="ico" src="/assets/images/ico-views.png" alt="" /> Views
      </li>
      <li class="action-item">
        <img class="ico" src="/assets/images/ico-projections.png" alt="" />
        Projections
      </li>
      <li class="action-item">
        <span class="action-group-separator">‚é∏</span>
      </li>
    </ul>

    <ul class="action-group">
      <li class="action-item">Main View</li>
      <li class="action-item">
        <img class="ico" src="/assets/images/ico-hide.png" alt="" /> Hide fields
      </li>
      <li class="action-item">
        <img class="ico" src="/assets/images/ico-filter.png" alt="" /> Filter
        fields
      </li>
      <li class="action-item">
        <img class="ico" src="/assets/images/ico-sort.png" alt="" /> Sort
      </li>
      <!-- <li class="action-item">Color</li> -->
      <li class="action-item">
        <img class="ico" src="/assets/images/ico-share.png" alt="" /> Share and
        sync
      </li>
    </ul>

    <ul class="action-group right-group">
      <li class="action-item">
        <img class="ico" src="/assets/images/ico-search.png" alt="" /> search
      </li>
    </ul>
  </div>

  <ul class="panels">
    <!-- <li class="child-panel">stuff</li> -->
    <li class="content-panel">
      <div class="table-container">
        <div class="data-view-container">
          <div class="scroll-inner-container">
            <!-- DATA ROW HEADER -->
            <div class="header-container">
              @for (field of tableRecordData?.FieldsMetaData; track $index) {
              <ul class="column-container">
                <li class="row-header-item row-item">
                  <div class="header-item-wrapper">
                    <ul
                      class="data-item"
                      cdkOverlayOrigin
                      #fieldContextOverlay="cdkOverlayOrigin"
                    >
                      <li class="field-name">
                        <img
                          class="ico"
                          src="/assets/images/{{ fieldTypeToImg(field) }}.png"
                          alt=""
                        />
                        {{ field.FieldName }}
                      </li>
                      <li
                        class="action-item"
                        (click)="onOpenFieldContextMenu(field.FieldGUID)"
                      >
                        <img
                          class="ico"
                          src="/assets/images/ico-context.png"
                          alt=""
                        />
                      </li>
                    </ul>
                  </div>
                </li>
              </ul>

              <!-- Field context menu template -->
              <ng-template
                cdkConnectedOverlay
                [cdkConnectedOverlayOrigin]="fieldContextOverlay"
                [cdkConnectedOverlayOpen]="
                  isFieldContextMenuOpen(field.FieldGUID)
                "
                (detach)="onFieldOverlayDetached()"
                (overlayOutsideClick)="onFieldOverlayDetached()"
              >
                @switch (showEditFieldOverlay) {
                <!--  -->
                @case (true) {
                <app-edit-field-context-menu-overlay
                  [field]="field"
                  [baseGUID]="baseGUID!"
                  [tableGUID]="selectedTableGUID!"
                  (closePanel)="onFieldOverlayDetached()"
                  (didClickSave)="onUpdateField($event)"
                ></app-edit-field-context-menu-overlay>
                <!-- <ng-container [ngTemplateOutlet]="edittemplate"></ng-container> -->
                }

                <!--  -->
                @case (false) {
                <app-field-context-menu-overlay
                  [field]="field"
                  (editField)="onEditField($event)"
                  (deleteField)="onDeleteField($event)"
                >
                  <!-- <hr /> -->
                  <!-- <div>stuff 1</div> -->
                  <!-- <div>stuff 2</div> -->
                  <!-- <div>stuff 3</div> -->
                </app-field-context-menu-overlay>
                } }
              </ng-template>

              }
              <!-- Add Filed -->
              <ul class="column-container">
                <li class="row-item">
                  <div class="header-item-wrapper">
                    <ul
                      class="data-item action-item"
                      cdkOverlayOrigin
                      #addFieldOverlay="cdkOverlayOrigin"
                      (click)="onOpenFieldContextMenu(AddFieldAction)"
                    >
                      <li class="field-name">
                        <img
                          class="ico"
                          src="/assets/images/ico-add.png"
                          alt=""
                        />Add field
                      </li>
                    </ul>
                  </div>
                </li>
              </ul>
            </div>

            <!-- BODY -->
            <div class="body-wrapper-container">
              <div class="body-container">
                <!-- prettier-ignore -->
                @for (field of tableRecordData?.FieldsMetaData; track $index; let colIndex = $index) {
                <!-- Column -->
                <div class="column-container">
                  <!-- prettier-ignore -->
                  @for (columnData of columnValues(field); track $index; let rowIndex = $index) {
                  <!-- Row -->
                  <div
                    class="row-item-wrapper"
                    tabindex="0"
                    [attr.data-cell-id]="
                      'row-item-wrapper-' + colIndex + '-' + rowIndex
                    "
                    (click)="
                      onSelectRowItem(
                        $event,
                        columnData,
                        field,
                        colIndex,
                        rowIndex
                      )
                    "
                  >
                    <!-- prettier-ignore -->
                    @let cellContext = {
                      field: field,
                      columnData: columnData,
                      colIndex: colIndex,
                      rowIndex: rowIndex
                    };
                    @if(isActiveCell(columnData)) {
                    <!-- prettier-ignore -->
                    <ng-container *ngTemplateOutlet="editCellTemplate; context: cellContext"></ng-container>
                    } @else {
                    <!-- prettier-ignore -->
                    <ng-container *ngTemplateOutlet="viewingCellTemplate; context: cellContext"></ng-container>
                    }
                  </div>
                  }
                </div>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="footer-container">
          <div>
            <div class="end-actions-container">
              <button class="action-item" (click)="onAddRow()">Add Row</button>
            </div>
          </div>
        </div>
      </div>
    </li>
  </ul>
</div>

<!-- Template for viewing mode -->
<ng-template
  #viewingCellTemplate
  let-field="field"
  let-columnData="columnData"
  let-colIndex="colIndex"
  let-rowIndex="rowIndex"
>
  <div
    class="row-item"
    cdkOverlayOrigin
    #tableCellContextMenu="cdkOverlayOrigin"
    (contextmenu)="onShowTableCellContextMenu(columnData.CellGUID)"
  >
    <div class="data-item">
      <!--  -->
      @switch (field.FieldType) {
      <!-- Handle Yes/No checkbox input -->
      @case (TableFieldType.FieldTypeYesNo) {
      <div
        class="value-item-container"
        [class.value-item-container-align-center]="isYesNoField(field)"
      >
        <input
          type="checkbox"
          class="field-item-yes-no"
          [checked]="presentColumnDataValue(field, columnData)"
          (click)="
            onClickedYesNoField($event, field, columnData, colIndex, rowIndex)
          "
        />
      </div>
      }
      <!-- Handle options -->
      @case(TableFieldType.FieldTypeOption) {
      <div class="value-item-container">
        <span
          *ngIf="hasColumnValue(columnData)"
          [class.option-value-container]="isOptionField(field)"
          [style.backgroundColor]="columnDataValueCellColor(field, columnData)"
        >
          {{ presentColumnDataValue(field, columnData) }}
        </span>
      </div>
      }
      <!-- Handle linked table relationship input -->
      @case(TableFieldType.FieldTypeRelationship) {
      @if(hasColumnValue(columnData)){
      <div class="value-item-container relationship-value-item-container">
        @for (data of linkedFieldDataValues(columnData); track $index; let
        rowIndex = $index) {
        <span class="linked-data-item">{{ data.DataValue }}</span>
        }
      </div>
      } @else {
      <span>&nbsp;--</span>
      } }
      <!-- Handle everything else -->
      @default {
      <div class="value-item-container">
        <span
          *ngIf="hasColumnValue(columnData)"
          [style.backgroundColor]="columnDataValueCellColor(field, columnData)"
        >
          {{ presentColumnDataValue(field, columnData) }}
        </span>
      </div>
      }
      <!-- End of switch -->
      }
    </div>
  </div>
  <ng-template
    cdkConnectedOverlay
    [cdkConnectedOverlayOrigin]="tableCellContextMenu"
    [cdkConnectedOverlayOpen]="isTableCellContextMenuOpen(columnData.CellGUID)"
    (detach)="onFieldOverlayDetached()"
    (overlayOutsideClick)="onFieldOverlayDetached()"
  >
    <app-table-cell-context-menu
      [field]="field"
      (deleteRecord)="onDeleteRecord($event, columnData.RecordGUID)"
    ></app-table-cell-context-menu>
  </ng-template>
</ng-template>

<!-- Template for editing mode -->
<ng-template
  #editCellTemplate
  let-field="field"
  let-columnData="columnData"
  let-colIndex="colIndex"
  let-rowIndex="rowIndex"
>
  <div class="active-row-item" cdkOverlayOrigin>
    <div class="active-data-item">
      <div class="value-item-container">
        <div class="input-wrapper">
          @switch (getFieldInputElement(field)) {
          <!-- Handle regular string input -->
          @case (FieldInputElement.Input) {
          <input
            #gridInputElement
            class="input-elm"
            type="text"
            [attr.data-cell-id]="'input-' + colIndex + '-' + rowIndex"
            (focus)="onCellFocus()"
            (blur)="onCellBlur()"
            (keyup)="
              onInputCellKeyup($event, field, columnData, colIndex, rowIndex)
            "
            [(ngModel)]="dirtyDataValue"
          />
          }
          <!-- Handle select input -->
          @case(FieldInputElement.Option) {
          <mat-select
            class="input-elm"
            style="font-size: 14px"
            #matSelect
            (selectionChange)="
              onChangedSelectedFieldOption(
                $event,
                field,
                columnData,
                colIndex,
                rowIndex
              )
            "
            (focus)="onCellFocus()"
            (click)="$event.stopPropagation()"
            [value]="columnData.DataValue"
            [(ngModel)]="dirtyDataValue"
            panelClass="panel-select-option"
          >
            @for (item of GetFieldOptionAsSelect(field); track $index) {
            <mat-option
              [value]="item.OptionId"
              class="option-value"
              (click)="$event.stopPropagation()"
            >
              {{ item.OptionName }}
            </mat-option>
            }
          </mat-select>
          }
          <!-- Handle linked table relationship input -->
          @case(FieldInputElement.LinkedTableRelationship) {
          <div
            cdkOverlayOrigin
            #addLinkedTableOverlay="cdkOverlayOrigin"
            (click)="onOpenFieldContextMenu(LinkedTableAction)"
            class="linked-table-relationship-input"
          >
            <span class="add-button">+</span>
          </div>

          <ng-template
            cdkConnectedOverlay
            [cdkConnectedOverlayOrigin]="addLinkedTableOverlay"
            [cdkConnectedOverlayOpen]="
              isFieldContextMenuOpen(LinkedTableAction)
            "
            (detach)="onFieldOverlayDetached()"
            (overlayOutsideClick)="onFieldOverlayDetached()"
          >
            <add-linked-table-overlay
              [field]="field"
              [baseGUID]="baseGUID!"
              [tableGUID]="selectedTableGUID!"
              (click)="$event.stopPropagation()"
              (selectColumnValue)="
                onSelectedLinkedTableValue(
                  $event,
                  field,
                  columnData,
                  colIndex,
                  rowIndex
                )
              "
              (closePanel)="onFieldOverlayDetached()"
            >
            </add-linked-table-overlay>
          </ng-template>
          }
          <!-- End of switch -->
          }
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- Template for Add Field Overlay -->
<ng-template
  cdkConnectedOverlay
  [cdkConnectedOverlayOrigin]="addFieldOverlay"
  [cdkConnectedOverlayOpen]="isFieldContextMenuOpen(AddFieldAction)"
  (detach)="onFieldOverlayDetached()"
  (overlayOutsideClick)="onFieldOverlayDetached()"
>
  <app-add-field-overlay
    [baseGUID]="baseGUID!"
    [tableGUID]="selectedTableGUID!"
    (closePanel)="onFieldOverlayDetached()"
    (didClickCreate)="onCreateField($event)"
  ></app-add-field-overlay>
</ng-template>
